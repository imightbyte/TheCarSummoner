<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&#129783 Gesture → Video Plays</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 20px; font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; }
        .container { display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; margin-top: 20px; }
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        canvas, video { border: 5px solid #333; border-radius: 12px; }
        button { padding: 15px 30px; font-size: 20px; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer; margin: 20px; }
        button:hover { background: #0056b3; }
        h1 { color: #333; }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body { margin: 10px; padding: 10px; }
            .container { flex-direction: column; gap: 20px; }
            .box { padding: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
            canvas, video { width: 100%; height: auto; max-width: 100%; }
            button { padding: 12px 24px; font-size: 18px; margin: 15px; }
            h1 { font-size: 24px; }
            p { font-size: 16px; }
        }
    </style>
</head>
<body>
    <h1>Show an &#129783 → Video Plays!</h1>
    <p>Close your hand → video pauses and resets</p>
    <!-- One-time activation button (required by browsers) -->
    <button id="startBtn">CLICK HERE TO ACTIVATE CAMERA & VIDEO</button>
    <div class="container" id="mainContainer" style="display:none;">
        <div class="box">
            <h2>Camera</h2>
            <video id="webcam" autoplay playsinline width="640" height="480" style="display:none;"></video>
            <canvas id="output_canvas" width="640" height="480"></canvas>
        </div>
        <div class="box">
            <h2>Brand Video</h2>
            <video id="myVideo" width="640" height="480" loop muted>
                <source src="Uber.mp4" type="video/mp4">
                Your browser does not support video.
            </video>
        </div>
    </div>
    <script>
        const startBtn = document.getElementById('startBtn');
        const mainContainer = document.getElementById('mainContainer');
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const targetVideo = document.getElementById('myVideo');
        let paperDetected = false;
        // Unlock everything on first click
        startBtn.onclick = async () => {
            startBtn.style.display = 'none';
            mainContainer.style.display = 'flex';
            // Preload the video so it can play instantly later
            targetVideo.load();
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`});
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6,
                selfieMode: true
            });
            hands.onResults(onResults);
            const camera = new Camera(videoElement, {
                onFrame: async () => await hands.send({image: videoElement}),
                width: 640,
                height: 480,
                facingMode: 'user'  // Use front camera on mobile
            });
            camera.start();

            // Fix for mobile self video stretching
            videoElement.addEventListener('loadedmetadata', () => {
                const aspect = videoElement.videoHeight / videoElement.videoWidth;
                function resizeCanvas() {
                    const displayWidth = canvasElement.parentElement.clientWidth - 20; // padding adjustment
                    canvasElement.width = displayWidth;
                    canvasElement.height = displayWidth * aspect;
                }
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
            });
        };
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            let currentPaper = false;
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (let idx = 0; idx < results.multiHandLandmarks.length; idx++) {
                    const landmarks = results.multiHandLandmarks[idx];
                    const handedness = results.multiHandedness ? results.multiHandedness[idx].label : 'Right';
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
                    if (isPaper(landmarks, handedness)) currentPaper = true;
                }
            }
            // Video control
            if (currentPaper && !paperDetected) {
                targetVideo.currentTime = 0;
                targetVideo.play(); // now allowed because user clicked the button first
                paperDetected = true;

                // Android-specific scroll to video
                const isAndroid = /Android/i.test(navigator.userAgent);
                if (isAndroid) {
                    targetVideo.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            } else if (!currentPaper && paperDetected) {
                targetVideo.pause();
                targetVideo.currentTime = 0;
                paperDetected = false;
            }
            canvasCtx.restore();
        }
        function isPaper(landmarks, handedness) {
            const lm = landmarks;
            const tips = [4, 8, 12, 16, 20];
            const mcps = [2, 5, 9, 13, 17];
            let extended = 0;
            for (let i = 0; i < 5; i++) {
                if (lm[tips[i]].y < lm[mcps[i]].y - 0.03) extended++;
            }
            if (extended < 4) return false;

            // Palm facing forward check with z-depth
            const wristZ = lm[0].z;
            const avgTipZ = (lm[4].z + lm[8].z + lm[12].z + lm[16].z + lm[20].z) / 5;
            const palmForward = avgTipZ < wristZ;
            if (!palmForward) return false;

            // Thumb side correct for left/right hand
            const isRightHand = handedness === 'Right';
            const thumbSideCorrect = isRightHand ? lm[4].x < lm[8].x : lm[4].x > lm[8].x;
            if (!thumbSideCorrect) return false;

            // Fingers spread out check
            const tipsX = [lm[4].x, lm[8].x, lm[12].x, lm[16].x, lm[20].x].sort((a, b) => a - b);
            let spread = true;
            for (let i = 1; i < 5; i++) {
                if (tipsX[i] - tipsX[i - 1] < 0.03) spread = false;
            }
            if (!spread) return false;

            return true;
        }
    </script>
</body>
</html>
